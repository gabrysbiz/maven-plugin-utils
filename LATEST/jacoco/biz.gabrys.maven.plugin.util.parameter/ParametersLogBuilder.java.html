<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ParametersLogBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Maven Plugin Utils</a> &gt; <a href="index.source.html" class="el_package">biz.gabrys.maven.plugin.util.parameter</a> &gt; <span class="el_source">ParametersLogBuilder.java</span></div><h1>ParametersLogBuilder.java</h1><pre class="source lang-java linenums">/*
 * Maven Plugin Utils
 * http://maven-plugin-utils.projects.gabrys.biz/
 *
 * Copyright (c) 2015 Adam Gabry≈õ
 *
 * This file is licensed under the BSD 3-Clause (the &quot;License&quot;).
 * You may not use this file except in compliance with the License.
 * You may obtain:
 * - a copy of the License at project page
 * - a template of the License at https://opensource.org/licenses/BSD-3-Clause
 */
package biz.gabrys.maven.plugin.util.parameter;

import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import org.apache.maven.plugin.logging.Log;

import biz.gabrys.maven.plugin.util.parameter.converter.DefaultValueToStringConverter;
import biz.gabrys.maven.plugin.util.parameter.converter.ValueToStringConverter;
import biz.gabrys.maven.plugin.util.parameter.sanitizer.AlwaysValidSanitizer;
import biz.gabrys.maven.plugin.util.parameter.sanitizer.ValueSanitizer;

/**
 * &lt;p&gt;
 * Builder which allows to log Mojos parameters values. It supports basic types like arrays and collections. All other
 * types are treat as {@link Object}s. The builder also provides API to use custom:
 * &lt;/p&gt;
 * &lt;ul&gt;
 * &lt;li&gt;{@link ValueToStringConverter} - responsible for converting parameter value to string representation&lt;/li&gt;
 * &lt;li&gt;{@link ValueSanitizer} - responsible for sanitizing Mojo parameter value&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * Example:
 * &lt;/p&gt;
 * 
 * &lt;pre&gt;
 * public class ExampleMojo extends AbstractMojo {
 *
 *     public void execute() {
 *         logParameters();
 *         ...
 *     }
 *
 *     private void logParameters() {
 *         ParametersLogBuilder logger = new ParametersLogBuilder(getLog());
 *
 *         // overwrite parameter
 *         logger.append(&quot;parameter&quot;, 1);
 *         logger.append(&quot;parameter&quot;, 2);
 *
 *         // default converter and sanitizer
 *         logger.append(&quot;booleanParameter&quot;, true);
 *         logger.append(&quot;stringArray&quot;, {&quot;one&quot;, &quot;two&quot;, &quot;three&quot;});
 *
 *         // custom converter
 *         logger.append(&quot;customObject&quot;, new Object(), new {@link ValueToStringConverter}() {
 *
 *             public String convert(final Object value) {
 *                 return &quot;custom object&quot;;
 *             }
 *         });
 *
 *         // simple sanitizer
 *         logger.append(&quot;booleanTrueValue&quot;, true, new {@link biz.gabrys.maven.plugin.util.parameter.sanitizer.SimpleSanitizer SimpleSanitizer}(true, Boolean.TRUE));
 *         logger.append(&quot;booleanFalseValue&quot;, false, new {@link biz.gabrys.maven.plugin.util.parameter.sanitizer.SimpleSanitizer SimpleSanitizer}(false, Boolean.TRUE));
 *
 *         // lazy sanitizer
 *         boolean condition1 = true;
 *         logger.append(&quot;stringLazyNotExecuted&quot;, &quot;lazy-not-executed&quot;, new {@link biz.gabrys.maven.plugin.util.parameter.sanitizer.LazySimpleSanitizer LazySimpleSanitizer}(condition1, new ValueContainer() {
 *
 *             public Object getValue() {
 *                 // never executed, because condition1 is equal to true 
 *                 return &quot;heavyOperation1()&quot;;
 *             }
 *         }));
 *         boolean condition2 = false;
 *         logger.append(&quot;stringLazyExecuted&quot;, &quot;lazy-executed&quot;, new {@link biz.gabrys.maven.plugin.util.parameter.sanitizer.LazySimpleSanitizer LazySimpleSanitizer}(condition2, new ValueContainer() {
 *
 *             public Object getValue() {
 *                 // executed, because condition2 is equal to false 
 *                 return &quot;heavyOperation2()&quot;;
 *             }
 *         }));
 *
 *         // custom sanitizer
 *         final String customSanitizerValue = null;
 *         logger.append(&quot;customSanitizerValue&quot;, customSanitizerValue, new {@link ValueSanitizer}() {
 *
 *             private Object sanitizedValue;
 *
 *             public boolean isValid(final Object value) {
 *                 if (customSanitizerValue != null) {
 *                     return true;
 *                 }
 *                 sanitizedValue = &quot;heavyOperation3()&quot;;
 *                 return sanitizedValue == null;
 *             }
 *
 *             public Object sanitize(final Object value) {
 *                 return sanitizedValue;
 *             }
 *         });
 *
 *         // log data
 *         logger.debug();
 *     }
 *
 *     ...
 * }
 * &lt;/pre&gt;
 * &lt;p&gt;
 * Output:
 * &lt;/p&gt;
 * 
 * &lt;pre&gt;
 * [DEBUG] Job parameters:
 * [DEBUG]       parameter = 2
 * [DEBUG]       booleanParameter = true
 * [DEBUG]       stringArray = [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]
 * [DEBUG]       customObject = custom object
 * [DEBUG]       booleanTrueValue = true
 * [DEBUG]       booleanFalseValue = false (calculated: true)
 * [DEBUG]       stringLazyNotExecuted = lazy-not-executed
 * [DEBUG]       stringLazyExecuted = lazy-executed (calculated: heavyOperation2())
 * [DEBUG]       customSanitizerValue = null (calculated: heavyOperation3())
 * &lt;/pre&gt;
 * 
 * @since 1.3.0
 */
public class ParametersLogBuilder {

    /**
     * Stores parameters names and associated containers.
     * @since 1.3.0
     * @see Container
     */
    protected final Map&lt;String, Container&gt; parameters;
    /**
     * Logger used to log parameters.
     * @since 1.3.0
     */
    protected final Log logger;

    /**
     * Constructs a new object.
     * @param logger the logger used to log parameters.
     * @throws IllegalArgumentException if the logger is equal to {@code null}.
     * @since 1.3.0
     */
    public ParametersLogBuilder(final Log logger) {
<span class="fc" id="L155">        this(new LinkedHashMap&lt;String, Container&gt;(), logger);</span>
<span class="fc" id="L156">    }</span>

    /**
     * Constructs a new object.
     * @param parameters the map which stores parameters names and associated containers.
     * @param logger the logger used to log parameters.
     * @throws IllegalArgumentException if the parameters or logger is equal to {@code null}.
     * @since 1.3.0
     */
<span class="fc" id="L165">    protected ParametersLogBuilder(final Map&lt;String, Container&gt; parameters, final Log logger) {</span>
<span class="fc" id="L166">        ParameterUtils.verifyNotNull(&quot;parameters&quot;, parameters);</span>
<span class="fc" id="L167">        ParameterUtils.verifyNotNull(&quot;logger&quot;, logger);</span>

<span class="fc" id="L169">        this.parameters = parameters;</span>
<span class="fc" id="L170">        this.logger = logger;</span>
<span class="fc" id="L171">    }</span>

    /**
     * Appends a parameter with a valid value. If parameter has been appended before, then it removes its previous value
     * and adds a new.
     * @param name the parameter name.
     * @param value the parameter value.
     * @return {@code this} builder.
     * @since 1.3.0
     * @see DefaultValueToStringConverter
     * @see AlwaysValidSanitizer
     */
    public ParametersLogBuilder append(final String name, final Object value) {
<span class="fc" id="L184">        return append(name, value, new DefaultValueToStringConverter(), new AlwaysValidSanitizer());</span>
    }

    /**
     * Appends a parameter with a valid value. If parameter has been appended before, then it removes its previous value
     * and adds a new.
     * @param name the parameter name.
     * @param value the parameter value.
     * @param converter the converter responsible for converting parameter value to string representation.
     * @return {@code this} builder.
     * @since 1.3.0
     * @see AlwaysValidSanitizer
     */
    public ParametersLogBuilder append(final String name, final Object value, final ValueToStringConverter converter) {
<span class="fc" id="L198">        return append(name, value, converter, new AlwaysValidSanitizer());</span>
    }

    /**
     * Appends a parameter with a valid value. If parameter has been appended before, then it removes its previous value
     * and adds a new.
     * @param name the parameter name.
     * @param value the parameter value.
     * @param sanitizer the sanitizer responsible for sanitizing parameter value.
     * @return {@code this} builder.
     * @since 1.3.0
     * @see DefaultValueToStringConverter
     */
    public ParametersLogBuilder append(final String name, final Object value, final ValueSanitizer sanitizer) {
<span class="fc" id="L212">        return append(name, value, new DefaultValueToStringConverter(), sanitizer);</span>
    }

    /**
     * Appends a parameter with a valid value. If parameter has been appended before, then it removes its previous value
     * and adds a new.
     * @param name the parameter name.
     * @param value the parameter value.
     * @param converter the converter responsible for converting parameter value to string representation.
     * @param sanitizer the sanitizer responsible for sanitizing parameter value.
     * @return {@code this} builder.
     * @since 1.3.0
     */
    public ParametersLogBuilder append(final String name, final Object value, final ValueToStringConverter converter,
            final ValueSanitizer sanitizer) {
<span class="fc" id="L227">        parameters.remove(name);</span>
<span class="fc" id="L228">        parameters.put(name, new Container(value, converter, sanitizer));</span>
<span class="fc" id="L229">        return this;</span>
    }

    /**
     * Logs appended parameters using info mode.
     * @return {@code true} whether the logger logged any data, otherwise {@code false}.
     * @since 1.3.0
     */
    public boolean info() {
<span class="fc" id="L238">        return log(new InfoInternalLoggerAdapter(logger));</span>
    }

    /**
     * Logs appended parameters using debug mode.
     * @return {@code true} whether the logger logged any data, otherwise {@code false}.
     * @since 1.3.0
     */
    public boolean debug() {
<span class="fc" id="L247">        return log(new DebugInternalLoggerAdapter(logger));</span>
    }

    /**
     * Logs appended parameters using {@link InternalLogger}.
     * @param internalLogger the logger used to log parameters.
     * @return {@code true} whether the logger logged any data, otherwise {@code false}.
     * @since 1.3.0
     * @see #info()
     * @see #debug()
     */
    protected boolean log(final InternalLogger internalLogger) {
<span class="fc bfc" id="L259" title="All 2 branches covered.">        if (!internalLogger.isEnabled()) {</span>
<span class="fc" id="L260">            return false;</span>
        }
<span class="fc" id="L262">        final List&lt;String&gt; lines = createLines();</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">        if (lines.isEmpty()) {</span>
<span class="fc" id="L264">            return false;</span>
        }
<span class="fc bfc" id="L266" title="All 2 branches covered.">        for (final String line : lines) {</span>
<span class="fc" id="L267">            internalLogger.log(line);</span>
<span class="fc" id="L268">        }</span>
<span class="fc" id="L269">        return true;</span>
    }

    /**
     * Creates all lines which will be logged by the logger.
     * @return the lines which will be logged by the logger.
     * @since 1.3.0
     * @see #log(InternalLogger)
     */
    protected List&lt;String&gt; createLines() {
<span class="fc" id="L279">        final List&lt;String&gt; lines = new ArrayList&lt;String&gt;(parameters.size() + 2);</span>
<span class="fc" id="L280">        lines.add(&quot;Job parameters:&quot;);</span>
<span class="fc" id="L281">        lines.addAll(createParametersLines());</span>
<span class="fc" id="L282">        lines.add(&quot;&quot;);</span>
<span class="fc" id="L283">        return lines;</span>
    }

    /**
     * Creates one line for every appended parameter.
     * @return the lines with parameters.
     * @since 1.3.0
     * @see #createLines()
     */
    protected List&lt;String&gt; createParametersLines() {
<span class="fc" id="L293">        final List&lt;String&gt; lines = new ArrayList&lt;String&gt;(parameters.size());</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">        for (final Map.Entry&lt;String, Container&gt; entry : parameters.entrySet()) {</span>
<span class="fc" id="L295">            lines.add(createParemeterLine(entry.getKey(), entry.getValue()));</span>
<span class="fc" id="L296">        }</span>
<span class="fc" id="L297">        return lines;</span>
    }

    /**
     * Creates a line for single parameter.
     * @param name the parameter name.
     * @param container the container which stores the parameter value and associated converter and sanitizer.
     * @return the line with the parameter name and value.
     * @since 1.3.0
     * @see #createParametersLines()
     */
    protected String createParemeterLine(final String name, final Container container) {
<span class="fc" id="L309">        final StringBuilder line = new StringBuilder();</span>
<span class="fc" id="L310">        line.append(&quot;      &quot;);</span>
<span class="fc" id="L311">        line.append(name);</span>
<span class="fc" id="L312">        line.append(&quot; = &quot;);</span>
<span class="fc" id="L313">        line.append(createParameterValue(container));</span>
<span class="fc" id="L314">        return line.toString();</span>
    }

    /**
     * Creates a string representation of the parameter value.
     * @param container the container which stores the parameter value and associated converter and sanitizer.
     * @return the string representation of the parameter value.
     * @since 1.3.0
     * @see #createParemeterLine(String, Container)
     */
    protected String createParameterValue(final Container container) {
<span class="fc" id="L325">        final StringBuilder line = new StringBuilder();</span>

<span class="fc" id="L327">        final ValueToStringConverter converter = container.getConverter();</span>
<span class="fc" id="L328">        final Object value = container.getValue();</span>
<span class="fc" id="L329">        final String valueText = String.valueOf(converter.convert(value));</span>
<span class="fc" id="L330">        line.append(valueText);</span>

<span class="fc" id="L332">        final ValueSanitizer sanitizer = container.getSanitizer();</span>
<span class="fc bfc" id="L333" title="All 2 branches covered.">        if (!sanitizer.isValid(value)) {</span>
<span class="fc" id="L334">            final Object calculatedValue = sanitizer.sanitize(value);</span>
<span class="fc" id="L335">            final String calculatedValueText = String.valueOf(converter.convert(calculatedValue));</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">            if (!valueText.equals(calculatedValueText)) {</span>
<span class="fc" id="L337">                line.append(&quot; (calculated: &quot;);</span>
<span class="fc" id="L338">                line.append(calculatedValueText);</span>
<span class="fc" id="L339">                line.append(')');</span>
            }
        }
<span class="fc" id="L342">        return line.toString();</span>
    }

    /**
     * Container which stores parameter value and associated converter and sanitizer.
     * @since 1.3.0
     */
    protected static class Container {

        private final Object value;
        private final ValueToStringConverter converter;
        private final ValueSanitizer sanitizer;

        /**
         * Constructs a new instance.
         * @param value the parameter value.
         * @param converter the converter responsible for converting parameter value to string representation.
         * @param sanitizer the sanitizer responsible for sanitizing parameter value.
         * @since 1.3.0
         */
<span class="fc" id="L362">        protected Container(final Object value, final ValueToStringConverter converter, final ValueSanitizer sanitizer) {</span>
<span class="fc" id="L363">            this.value = value;</span>
<span class="fc" id="L364">            this.converter = converter;</span>
<span class="fc" id="L365">            this.sanitizer = sanitizer;</span>
<span class="fc" id="L366">        }</span>

        /**
         * Returns a parameter value.
         * @return the parameter value.
         * @since 1.3.0
         */
        protected Object getValue() {
<span class="nc" id="L374">            return value;</span>
        }

        /**
         * Returns a converter responsible for converting parameter value to string representation.
         * @return the converter.
         * @since 1.3.0
         */
        protected ValueToStringConverter getConverter() {
<span class="fc" id="L383">            return converter;</span>
        }

        /**
         * Returns a sanitizer responsible for sanitizing parameter value.
         * @return the sanitizer.
         * @since 1.3.0
         */
        protected ValueSanitizer getSanitizer() {
<span class="fc" id="L392">            return sanitizer;</span>
        }
    }

    /**
     * &lt;p&gt;
     * Used to adaptation instance of the {@link org.apache.maven.plugin.logging.Log} to logger used in the
     * {@link ParametersLogBuilder#log(InternalLogger)} method.
     * &lt;/p&gt;
     * @since 1.3.0
     */
    protected interface InternalLogger {

        /**
         * Checks whether a logger is enabled.
         * @return {@code true} whether the logger is enabled, otherwise {@code false}.
         * @since 1.3.0
         */
        boolean isEnabled();

        /**
         * Logs a line.
         * @param line the line to log.
         * @since 1.3.0
         */
        void log(CharSequence line);
    }

    /**
     * Adapts {@link org.apache.maven.plugin.logging.Log} to {@link InternalLogger} API which uses info mode.
     * @since 1.3.0
     * @see ParametersLogBuilder#info()
     */
    protected static class InfoInternalLoggerAdapter implements InternalLogger {

        private final Log logger;

        /**
         * Constructs a new instance.
         * @param logger the adapted logger.
         * @since 1.3.0
         */
<span class="fc" id="L434">        protected InfoInternalLoggerAdapter(final Log logger) {</span>
<span class="fc" id="L435">            this.logger = logger;</span>
<span class="fc" id="L436">        }</span>

        @Override
        public boolean isEnabled() {
<span class="fc" id="L440">            return logger.isInfoEnabled();</span>
        }

        @Override
        public void log(final CharSequence line) {
<span class="fc" id="L445">            logger.info(line);</span>
<span class="fc" id="L446">        }</span>
    }

    /**
     * Adapts {@link org.apache.maven.plugin.logging.Log} to {@link InternalLogger} API which uses debug mode.
     * @since 1.3.0
     * @see ParametersLogBuilder#debug()
     */
    protected static class DebugInternalLoggerAdapter implements InternalLogger {

        private final Log logger;

        /**
         * Constructs a new instance.
         * @param logger the adapted logger.
         * @since 1.3.0
         */
<span class="fc" id="L463">        protected DebugInternalLoggerAdapter(final Log logger) {</span>
<span class="fc" id="L464">            this.logger = logger;</span>
<span class="fc" id="L465">        }</span>

        @Override
        public boolean isEnabled() {
<span class="fc" id="L469">            return logger.isDebugEnabled();</span>
        }

        @Override
        public void log(final CharSequence line) {
<span class="fc" id="L474">            logger.debug(line);</span>
<span class="fc" id="L475">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>